name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write
  actions: write

jobs:
  build:
    uses: ./.github/workflows/build-ci.yml

  release:
    name: æ‰“åŒ… & å‘å¸ƒ
    needs: build
    runs-on: windows-latest
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–ç‰ˆæœ¬å·å’Œå¾®ä¿¡ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          $version_full = (Select-String -Path "WeChatFerry/spy/spy.rc" -Pattern 'VALUE "FileVersion", "(.*)"').Matches.Groups[1].Value.Trim()
          $wechat_version = (Select-String -Path "WeChatFerry/spy/spy.rc" -Pattern 'VALUE "ProductVersion", "(.*)"').Matches.Groups[1].Value.Trim()
          $version = $version_full -replace '(\d+\.\d+\.\d+)\.\d+', '$1'
          echo "version=$version" >> $env:GITHUB_ENV
          echo "wechat_version=$wechat_version" >> $env:GITHUB_ENV
          echo "Program Version: $version"
          echo "WeChat Version: $wechat_version"

      - name: æ‰“åŒ…è¾“å‡ºæ–‡ä»¶åŠä¸‹è½½ WeChat å®‰è£…åŒ…
        shell: pwsh
        run: |
          # åœ¨æ ¹ç›®å½•åˆ›å»º tmp
          New-Item -ItemType Directory -Force -Path tmp

          # å‹ç¼©æ ¹ç›®å½•ä¸‹ Out ä¸­çš„äº§ç‰©
          Compress-Archive `
            -Path "WeChatFerry/Out/sdk.dll","WeChatFerry/Out/spy.dll","WeChatFerry/Out/spy_debug.dll","WeChatFerry/Out/DISCLAIMER.md" `
            -DestinationPath "tmp/v${{ env.version }}.zip"

          # ä¸‹è½½å¯¹åº” WeChat å®‰è£…åŒ…
          Invoke-WebRequest `
            -Uri "https://github.com/tom-snow/wechat-windows-versions/releases/download/v${{ env.wechat_version }}/WeChatSetup-${{ env.wechat_version }}.exe" `
            -OutFile "tmp/WeChatSetup-${{ env.wechat_version }}.exe"

      - name: åˆ—å‡ºå¾…å‘å¸ƒæ–‡ä»¶
        shell: pwsh
        run: Get-ChildItem -Path tmp -Recurse

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: ncipollo/release-action@main
        with:
          name: v${{ env.version }}
          tag: v${{ env.version }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          artifacts: "tmp/*"
          body: |
            ç¨‹åºç‰ˆæœ¬ï¼š`v${{ env.version }}`
            é…å¥—å¾®ä¿¡ç‰ˆæœ¬ï¼š`${{ env.wechat_version }}`
            [ğŸ“– Python æ–‡æ¡£](https://wechatferry.readthedocs.io/)
