name: Build-WeChatFerry

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–ç‰ˆæœ¬å·å’Œå¾®ä¿¡ç‰ˆæœ¬å·
        run: |
          $version_full = (Select-String -Path "WeChatFerry/spy/spy.rc" -Pattern 'VALUE "FileVersion", "(.*)"').Matches.Groups[1].Value.Trim()
          $wechat_version = (Select-String -Path "WeChatFerry/spy/spy.rc" -Pattern 'VALUE "ProductVersion", "(.*)"').Matches.Groups[1].Value.Trim()
          $version = $version_full -replace '(\d+\.\d+\.\d+)\.\d+', '$1'
          echo "version=$version" >> $env:GITHUB_ENV
          echo "wechat_version=$wechat_version" >> $env:GITHUB_ENV
          echo "Program Version: $version"
          echo "WeChat Version: $wechat_version"
        shell: pwsh

      - name: è®¾ç½® Visual Studio 2019
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: "16.0" # 16.x å¯¹åº” Visual Studio 2019

      - name: è®¾ç½® Python 3
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: å®‰è£… Python ä¾èµ–é¡¹
        run: |
          python -m pip install --upgrade pip
          pip install grpcio-tools==1.48.2

      - name: è®¾ç½®ç¼“å­˜
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: |
            C:/Tools/vcpkg
            ${{ github.workspace }}/WeChatFerry/vcpkg_installed
          key: vcpkg-${{ hashFiles('WeChatFerry/vcpkg.json') }}
          restore-keys: |
            vcpkg-

      - name: å®‰è£… vcpkg å¹¶åˆå§‹åŒ–ä¾èµ–é¡¹
        run: |
          # è®¾ç½® vcpkg ç›®å½•
          if (!(Test-Path -Path 'C:/Tools')) {
            New-Item -ItemType Directory -Force -Path 'C:/Tools'
          }
          cd C:/Tools

          # å…‹éš†å¹¶å¼•å¯¼ vcpkg
          if (!(Test-Path -Path 'C:/Tools/vcpkg')) {
            git clone https://github.com/microsoft/vcpkg
          }
          .\vcpkg\bootstrap-vcpkg.bat

          # è®¾ç½® VCPKG_ROOT ç¯å¢ƒå˜é‡
          echo "VCPKG_ROOT=C:/Tools/vcpkg" >> $GITHUB_ENV
          $env:VCPKG_ROOT = 'C:/Tools/vcpkg'

          # è¿”å›åˆ°é¡¹ç›®ç›®å½•å¹¶å®‰è£…ä¾èµ–
          cd ${{ github.workspace }}/WeChatFerry
          C:/Tools/vcpkg/vcpkg install --triplet x64-windows-static

          # å°† vcpkg ä¸ Visual Studio é›†æˆ
          C:/Tools/vcpkg/vcpkg integrate install

      - name: è§£æå¹¶æ„å»ºé…ç½®
        run: |
          $configurations = "Release,Debug".Split(',')
          foreach ($config in $configurations) {
            Write-Host "Building configuration: $config"
            msbuild WeChatFerry/WeChatFerry.sln `
              /p:Configuration=$config `
              /p:Platform="x64" `
              /p:VcpkgTriplet="x64-windows-static" `
              /p:VcpkgEnableManifest=true `
              /verbosity:minimal
          }
        shell: pwsh

      - name: æ‰“åŒ…è¾“å‡ºæ–‡ä»¶åŠä¸‹è½½ WeChat å®‰è£…åŒ…
        run: |
          New-Item -ItemType Directory -Force -Path "WeChatFerry/tmp"
          Compress-Archive -Path "WeChatFerry/Out/sdk.dll", "WeChatFerry/Out/spy.dll", "WeChatFerry/Out/spy_debug.dll" -DestinationPath "WeChatFerry/tmp/v${{ env.version }}.zip"
          Invoke-WebRequest -Uri "https://github.com/tom-snow/wechat-windows-versions/releases/download/v${{ env.wechat_version }}/WeChatSetup-${{ env.wechat_version }}.exe" -OutFile "WeChatFerry/tmp/WeChatSetup-${{ env.wechat_version }}.exe"
        shell: pwsh

      - name: åˆ—å‡ºé¢„å‘å¸ƒæ–‡ä»¶
        run: |
          Get-ChildItem -Path "WeChatFerry/tmp" -Recurse

      - name: å‘å¸ƒå›ºä»¶åˆ° Github Releases
        uses: ncipollo/release-action@main
        with:
          name: v${{ env.version }}
          tag: v${{ env.version }}
          token: ${{ secrets.REPO_TOKEN }}
          allowUpdates: true
          artifacts: "WeChatFerry/tmp/*"
          body: |
            ç¨‹åºç‰ˆæœ¬ï¼š`v${{ env.version }}`
            é…å¥—å¾®ä¿¡ç‰ˆæœ¬ï¼š`${{ env.wechat_version }}`
            [ğŸ“– Python æ–‡æ¡£](https://wechatferry.readthedocs.io/)
