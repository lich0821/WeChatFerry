# WeChatFerry Python å®¢æˆ·ç«¯
âš ï¸ **åªæ”¯æŒ Windows** âš ï¸

ğŸ¤–ç¤ºä¾‹æœºå™¨äººæ¡†æ¶ï¼š[WeChatRobot](https://github.com/lich0821/WeChatRobot)ã€‚

## å¿«é€Ÿå¼€å§‹
```sh
pip install --upgrade wcferry
```

### æ¥å£æ¸…å•
* æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼š`is_login`
* è·å–ç™»å½•è´¦å·çš„ wxidï¼š`get_self_wxid`
* è·å–æ¶ˆæ¯ç±»å‹ï¼š`get_msg_types`
* è·å–æ‰€æœ‰è”ç³»äººï¼š`get_contacts`
* è·å–æ‰€æœ‰å¥½å‹ï¼š`get_friends`
* è·å–æ•°æ®åº“ï¼š`get_dbs`
* è·å–æŸæ•°æ®åº“ä¸‹çš„è¡¨ï¼š`get_tables`
* è·å–ç”¨æˆ·ä¿¡æ¯ï¼š`get_user_info`
* å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼ˆå¯ @ï¼‰ï¼š`send_text`
* å‘é€å›¾ç‰‡ï¼š`send_image`
* å‘é€æ–‡ä»¶ï¼š`send_file`
* å‘é€ XMLï¼š`send_xml`
* å‘é€è¡¨æƒ…ï¼š`send_emotion`
* å…è®¸æ¥æ”¶æ¶ˆæ¯ï¼š`enable_receiving_msg` å’Œ `enable_recv_msgï¼ˆæ—§æ¥å£ï¼‰`
* åœæ­¢æ¥æ”¶æ¶ˆæ¯ï¼š`disable_recv_msg`
* æ‰§è¡Œ SQL æŸ¥è¯¢ï¼š`query_sql`
* æ¥å—å¥½å‹ç”³è¯·ï¼š`accept_new_friend`
* æ·»åŠ ç¾¤æˆå‘˜ï¼š`add_chatroom_members`
* è§£å¯†å›¾ç‰‡ï¼š`decrypt_image`

è¯¦æƒ…æŸ¥çœ‹ [client.py](wcferry/client.py)ã€‚

### Demoï¼š
```py
#! /usr/bin/env python3
# -*- coding: utf-8 -*-

import logging
from threading import Thread
from time import sleep

from wcferry import Wcf

logging.basicConfig(level='DEBUG', format="%(asctime)s %(message)s")
LOG = logging.getLogger("Demo")


def process_msg(wcf: Wcf):
    """å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯"""
    while wcf.is_receiving_msg():
        try:
            msg = wcf.get_msg()
        except Exception as e:
            continue

        LOG.info(msg)  # ç®€å•æ‰“å°


def main():
    LOG.info("Start demo...")
    wcf = Wcf(debug=True)             # é»˜è®¤è¿æ¥æœ¬åœ°æœåŠ¡
    # wcf = Wcf("tcp://127.0.0.1:10086") # è¿æ¥è¿œç«¯æœåŠ¡

    sleep(5)  # ç­‰å¾®ä¿¡åŠ è½½å¥½ï¼Œä»¥å…ä¿¡æ¯æ˜¾ç¤ºå¼‚å¸¸
    LOG.info(f"å·²ç»ç™»å½•: {True if wcf.is_login() else False}")
    LOG.info(f"wxid: {wcf.get_self_wxid()}")

    # å…è®¸æ¥æ”¶æ¶ˆæ¯
    # wcf.enable_recv_msg(LOG.info) # deprecated

    # å…è®¸æ¥æ”¶æ¶ˆæ¯
    wcf.enable_receiving_msg()
    Thread(target=process_msg, name="GetMessage", args=(wcf,), daemon=True).start()

    # wcf.disable_recv_msg() # å½“éœ€è¦åœæ­¢æ¥æ”¶æ¶ˆæ¯æ—¶è°ƒç”¨

    ret = wcf.send_text("Hello world.", "filehelper")
    LOG.info(f"send_text: {ret}")

    ret = wcf.send_image("TEQuant.jpeg", "filehelper")  # éœ€è¦ç¡®ä¿å›¾ç‰‡è·¯å¾„æ­£ç¡®
    LOG.info(f"send_image: {ret}")

    ret = wcf.send_file("README.MD", "filehelper")  # éœ€è¦ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
    LOG.info(f"send_file: {ret}")

    LOG.info(f"Message types:\n{wcf.get_msg_types()}")
    LOG.info(f"Contacts:\n{wcf.get_contacts()}")

    LOG.info(f"DBs:\n{wcf.get_dbs()}")
    LOG.info(f"Tables:\n{wcf.get_tables('db')}")
    LOG.info(f"Results:\n{wcf.query_sql('MicroMsg.db', 'SELECT * FROM Contact LIMIT 1;')}")

    # éœ€è¦çœŸæ­£çš„ V3ã€V4 ä¿¡æ¯
    # wcf.accept_new_friend("v3", "v4")

    # å¡«å†™æ­£ç¡®çš„ç¾¤ ID å’Œæˆå‘˜ wxid
    # ret = wcf.add_chatroom_members("chatroom id", "wxid1,wxid2,wxid3,...")
    # LOG.info(f"add_chatroom_members: {ret}")

    xml = '<?xml version="1.0"?><msg><appmsg appid="" sdkver="0"><title>å®å½“è¯æˆ¿ï¼Œ24å°æ—¶æœåŠ¡ï¼Œ28åˆ†é’Ÿé€è¯åˆ°å®¶ï¼</title><des>å®å½“å¿«è¯é¦–å®¶æ‰¿è¯ºèŒƒå›´å†…28åˆ†é’Ÿé€è¯åˆ°å®¶ï¼å®å½“å¿«è¯æ ¸å¿ƒåŒºåŸŸå†…7*24å°æ—¶å…¨å¤©å€™æœåŠ¡ï¼Œé€è¯ä¸Šé—¨ï¼å®å½“å¿«è¯å®˜ç½‘ä¸ºæ‚¨æä¾›å¿«æ·ä¾¿åˆ©ï¼Œæ­£å“ä½ä»·ï¼Œå®‰å…¨æ”¾å¿ƒçš„è´­è¯ã€é€è¯æœåŠ¡ä½“éªŒã€‚</des><action>view</action><type>33</type><showtype>0</showtype><content /><url>https://mp.weixin.qq.com/mp/waerrpage?appid=wxc2edadc87077fa2a&amp;type=upgrade&amp;upgradetype=3#wechat_redirect</url><dataurl /><lowurl /><lowdataurl /><recorditem /><thumburl /><messageaction /><md5>7f6f49d301ebf47100199b8a4fcf4de4</md5><extinfo /><sourceusername>gh_c2b88a38c424@app</sourceusername><sourcedisplayname>å®å½“å¿«è¯ è¯åº—é€è¯åˆ°å®¶å¤œé—´ä¹°è¯</sourcedisplayname><commenturl /><appattach><totallen>0</totallen><attachid /><emoticonmd5></emoticonmd5><fileext>jpg</fileext><filekey>da0e08f5c7259d03da150d5e7ca6d950</filekey><cdnthumburl>3057020100044b30490201000204e4c0232702032f4ef20204a6bace6f02046401f62d042430326337303430352d333734332d343362652d623335322d6233333566623266376334620204012400030201000405004c537600</cdnthumburl><aeskey>0db26456caf243fbd4efb99058a01d66</aeskey><cdnthumbaeskey>0db26456caf243fbd4efb99058a01d66</cdnthumbaeskey><encryver>1</encryver><cdnthumblength>61558</cdnthumblength><cdnthumbheight>100</cdnthumbheight><cdnthumbwidth>100</cdnthumbwidth></appattach><weappinfo><pagepath>pages/index/index.html</pagepath><username>gh_c2b88a38c424@app</username><appid>wxc2edadc87077fa2a</appid><version>197</version><type>2</type><weappiconurl>http://wx.qlogo.cn/mmhead/Q3auHgzwzM4727n0NQ0ZIPQPlfp15m1WLsnrXbo1kLhFGcolgLyc0A/96</weappiconurl><appservicetype>0</appservicetype><shareId>1_wxc2edadc87077fa2a_29177e9a9b918cb9e75964f80bb8f32e_1677849476_0</shareId></weappinfo><websearch /></appmsg><fromusername>wxid_xxxxxxxxxxxxxx</fromusername><scene>0</scene><appinfo><version>1</version><appname /></appinfo><commenturl /></msg>'
    ret = wcf.send_xml("filehelper", xml, 0x21)
    LOG.info(f"send_xml: {ret}")

    ret = wcf.send_emotion("emo.gif", "filehelper")  # éœ€è¦ç¡®ä¿ gif è·¯å¾„æ­£ç¡®
    LOG.info(f"send_emotion: {ret}")

    # ä¸€ç›´è¿è¡Œ
    wcf.keep_running()


if __name__ == "__main__":
    main()

```

## ä¸€èµ·å¼€å‘
### é…ç½®ç¯å¢ƒ
```sh
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .env
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .env/Scripts/activate
# å‡çº§ pip
pip install --upgrade pip
# å®‰è£…ä¾èµ–åŒ…
pip install grpcio-tools pynng
```

### é‡æ–°ç”Ÿæˆ PB æ–‡ä»¶
```sh
cd python\wcferry
# CMD
python -m grpc_tools.protoc --python_out=. --proto_path=..\..\rpc\proto\ wcf.proto

# GitBash
python -m grpc_tools.protoc --python_out=. --proto_path=../../rpc/proto/ wcf.proto
```
